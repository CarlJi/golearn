[TOC]

## 前言

前一节，主要从上层建筑层面描述云计算测试技术体系的各个方面，以期给大家建立一个全面的参考。这些方向并没有严格的时间先后顺序，在产品的迭代时期，可以并行发展。而本篇将书接上回，重点给大家描述下，理想中的业务测试自动化形态应该是怎样的, 以此希望能为更多的测试同行提供更真切的指引。

质量保证工作一定是站在**保证业务质量，提升迭代效率**层面出发的，不能抛离了此主线的。而做好集成测试阶段的验收工作，对保证业务质量效果应该是最明显的。所以在日常实践中，我们可能会采用各种策略，来尽可能的覆盖更多的业务场景，保证不出问题。但前文已经提到，传统模式比较依赖于人的素养，容易遗漏问题。那有没有可能存在一种方案或者工具来替代大部分的人力验收成本，减少遗漏，做到尽可能的高覆盖呢?

私以为云计算的模式，为这种方案提供了可能。因为多数云计算服务对外都提供统一的HTTP API入口，而用户只要遵循这些协议就可以使用云服务，却不用管其使用的端是什么。所以，如果能模拟所有用户的真实的请求，来作为我们的测试用例，这样基本上所有现有的业务场景就能都覆盖到。同时，在此基础上，还可以模拟触发各种故障场景，通过监控业务和服务的各种质量指标来检测云服务对于异常场景的处理能力。这样一正一反，才能更好的做到对业务场景的测试高覆盖。

这样的系统，我把它叫做：**云计算集成测试全回归系统**

## 云计算集成测试全回归系统

#### 系统架构图

![image-20180618220237832](/var/folders/_6/t59gxn4d0zz12vqlm3j3gwhr0000gn/T/abnerworks.Typora/image-20180618220237832.png)



这个系统应该作为整个发布Pipeline其中的一环，对应测试环境的预发布环节。只有经过这个系统验收的服务，才会被允许发布到线上环境。总的来讲，要做成这个系统，从技术层面有几个需求需要解决: **全面真实的测试用例，故障注入系统，质量监测平台。**

后两者，我们在前一篇已经提过，所以我们这里重点说说测试用例这快。

#### 测试用例

测试用例需要真实，且场景全面。要做到这两点，需要基于被测业务形态做实际分析。如果能总结出特定的规律，基于可枚举的方式来覆盖那固然是好。如果不行，那就退而求其次，考虑从线上导流。

业界有两个比较好用的流量复制工具Goreplay和TCPCopy, 一个是复制HTTP请求，一个是TCP，各有其优缺点。利用这个两个工具，构建一个预发布的环境，让所有的服务发布时，在这个环境灰度一段时间，就能检测到很多上线后才会遇到的功能问题。这个事情很重要，因为你会发现，绝大部分的故障都发生在做线上变更的情况下。所以对预发布环境的构建，应当作为测试技术发展上的非常重要的一环去建设。

当然，当有了这套系统之后，你可能会发现还不够完善。因为我们在使用这些工具复制流量时，一般都会选择特定时间段的，且会固定的选择的某一台机器的流量来复制。一是线上的流量一般很大，如果都复制过来，测试环境是抗不住的，另一方面复制流量会导致业务机器负载变高，可能会影响业务，需要在低峰期操作。所以在此情形下，有可能会导致我们复制的流量的共性比较多，覆盖不到所有的业务场景。

要想生成更全面的测试用例，需要对这一块进行更深层次的管理。我们可以针对流量请求做更深层次的分析，比如具体的URL是什么，http header是否有特殊的，body的size是怎样的等等。然后基于业务，勾画测试用例模型，同时建立用例仓库，将所有的请求，进行预处理操作，去冗余，然后分门别类的落入用例仓库。当需要在测试环境回放时，就由该系统，按照指定的要求，比如QPS，各服务间的覆盖等等，对预发布环境进行功能测试，压力测试。

有了这套系统，理论上所有的回归问题，都应该能被覆盖到。之后，平时的迭代就只需要关注新功能，新需求，迭代压力会小很多，迭代的效率也会提高很多。

当然再次强调，既然这是个预发布环境，**监测系统**必须要有，它能帮助我们检测到很多系统内部问题，也能辅助问题分析。同时，还需要借助故障注入机制，来验收反向场景。

至此，一正一反，外加业务质量透视，集成测试覆盖上才是全面。

## 总结

总体来讲，方向很清晰，但过程还是要有的。这套系统，改变了传统测试同学基于迭代添加测试用例的方式，在模式上提出了更高的要求。且理论上，这套东西真正运行起来，应该更多的交付研发来使用，测试同学主要负责指导和维护这套机制，保证质量体系中，整套代码到上线的流水线流畅运转，这样我们才是真正在解决质量与效率问题上迈出一大步。



> 童鞋，点个赞吧(⊙o⊙)？



## Contact me ?

Email: jinsdu@outlook.com

Blog: <http://www.cnblogs.com/jinsdu/>

Github: <https://github.com/CarlJi>

知乎: https://www.zhihu.com/people/jinsdu/posts

------